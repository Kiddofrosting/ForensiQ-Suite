{% extends "base.html" %}

{% block title %}Evidence Details - ForensIQ Suite{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-file-earmark-lock"></i> Evidence Details</h2>
        <p class="text-muted mb-0">{{ evidence.file_name }}</p>
    </div>
    <div>
        <a href="{{ url_for('cases.view_case', case_id=case._id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Case
        </a>
        {% if session.role not in ['osint_analyst'] %}
        <a href="{{ url_for('evidence.download_evidence', evidence_id=evidence._id) }}" class="btn btn-success">
            <i class="bi bi-download"></i> Download
        </a>
        {% endif %}
        {% if session.role in ['admin', 'case_manager', 'legal_reviewer'] %}
        <form method="POST" action="{{ url_for('evidence.verify_evidence', evidence_id=evidence._id) }}"
              style="display: inline;" onsubmit="return confirm('Verify evidence integrity?');">
            <button type="submit" class="btn btn-warning">
                <i class="bi bi-shield-check"></i> Verify Integrity
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <!-- Main Details -->
    <div class="col-lg-8">
        <!-- File Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> File Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3"><strong>File Name:</strong></div>
                    <div class="col-md-9">{{ evidence.file_name }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>File Type:</strong></div>
                    <div class="col-md-9"><code>{{ evidence.file_type }}</code></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>File Size:</strong></div>
                    <div class="col-md-9">{{ (evidence.file_size / 1024 / 1024)|round(2) }} MB</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>Uploaded By:</strong></div>
                    <div class="col-md-9">{{ evidence.uploaded_by }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>Upload Date:</strong></div>
                    <div class="col-md-9">{{ evidence.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') if evidence.uploaded_at else 'N/A' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>Retention Until:</strong></div>
                    <div class="col-md-9">{{ evidence.retention_until.strftime('%Y-%m-%d') if evidence.retention_until else 'Indefinite' }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3"><strong>Description:</strong></div>
                    <div class="col-md-9">{{ evidence.description if evidence.description else 'No description provided' }}</div>
                </div>
                <div class="row">
                    <div class="col-md-3"><strong>Tags:</strong></div>
                    <div class="col-md-9">
                        {% if evidence.tags %}
                            {% for tag in evidence.tags %}
                                <span class="badge bg-light text-dark">{{ tag }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No tags</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Hash Values -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-fingerprint"></i> Cryptographic Hashes</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>SHA-256:</strong>
                    <div class="input-group mt-1">
                        <input type="text" class="form-control evidence-hash" value="{{ evidence.sha256_hash }}"
                               id="sha256" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('sha256')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>MD5:</strong>
                    <div class="input-group mt-1">
                        <input type="text" class="form-control evidence-hash" value="{{ evidence.md5_hash }}"
                               id="md5" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('md5')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-0">
                    <strong>SHA-1:</strong>
                    <div class="input-group mt-1">
                        <input type="text" class="form-control evidence-hash" value="{{ evidence.sha1_hash }}"
                               id="sha1" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('sha1')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata -->
        {% if evidence.metadata %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> Extracted Metadata</h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 mb-0" style="max-height: 300px; overflow-y: auto;">{{ evidence.metadata|tojson(indent=2) }}</pre>
            </div>
        </div>
        {% endif %}

        <!-- Chain of Custody -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Chain of Custody</h5>
            </div>
            <div class="card-body">
                {% if evidence.chain_of_custody %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>IP Address</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in evidence.chain_of_custody %}
                            <tr>
                                <td><small>{{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') if entry.timestamp else 'N/A' }}</small></td>
                                <td><span class="badge bg-info">{{ entry.action }}</span></td>
                                <td>{{ entry.username }}</td>
                                <td><code>{{ entry.ip_address }}</code></td>
                                <td><small>{{ entry.details }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No chain of custody entries</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Status -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-shield-check"></i> Verification Status</h6>
            </div>
            <div class="card-body">
                {% if evidence.verified_by %}
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle-fill"></i> <strong>Verified</strong><br>
                    <small>By: {{ evidence.verified_by }}</small><br>
                    <small>Date: {{ evidence.verified_at.strftime('%Y-%m-%d %H:%M') if evidence.verified_at else 'N/A' }}</small>
                </div>
                {% else %}
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Not Verified</strong><br>
                    <small>Evidence integrity has not been verified</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Case Info -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-folder"></i> Associated Case</h6>
            </div>
            <div class="card-body">
                <p><strong>{{ case.case_number }}</strong></p>
                <p class="mb-2">{{ case.title }}</p>
                <a href="{{ url_for('cases.view_case', case_id=case._id) }}" class="btn btn-sm btn-outline-primary w-100">
                    <i class="bi bi-eye"></i> View Case
                </a>
            </div>
        </div>

        <!-- Actions -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Actions</h6>
            </div>
            <div class="card-body">
                {% if session.role not in ['osint_analyst'] %}
                <a href="{{ url_for('evidence.download_evidence', evidence_id=evidence._id) }}"
                   class="btn btn-success w-100 mb-2">
                    <i class="bi bi-download"></i> Download File
                </a>
                {% endif %}

                {% if session.role in ['admin', 'case_manager', 'legal_reviewer'] %}
                <form method="POST" action="{{ url_for('evidence.verify_evidence', evidence_id=evidence._id) }}"
                      onsubmit="return confirm('Verify evidence integrity? This will check the current file hash against the original.');">
                    <button type="submit" class="btn btn-warning w-100 mb-2">
                        <i class="bi bi-shield-check"></i> Verify Integrity
                    </button>
                </form>
                {% endif %}

                <button class="btn btn-outline-secondary w-100" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print Details
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(id) {
        const input = document.getElementById(id);
        input.select();
        document.execCommand('copy');
        alert('Hash copied to clipboard!');
    }
</script>
{% endblock %}